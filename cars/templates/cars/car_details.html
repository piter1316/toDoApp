{% extends 'todo/base.html' %}
{% block body %}
{% load static %}
{% load average_fuel_cons %}
{% load render_table from django_tables2 %}
<div class="container-fluid mt-2">
  <div class="row">
    <div class="col-12 col-xl-9 ">
      <ul class="nav nav-tabs mb-1 row no-gutters" id="myTab" role="tablist">
        <li class="nav-item col">
          <a class="btn btn-outline-secondary active border-right-0 w-100" id="fuel-tab" data-toggle="tab" href="#fuel"
             role="tab"
             aria-controls="fuel" aria-selected="true" style=" border-radius: 5px 0px 0px 5px !important;"><i
              class=" px-2 fas fa-gas-pump"></i></a>
        </li>
        <li class="nav-item col">
          <a class="btn btn-outline-secondary rounded-0 w-100" id="service-tab" data-toggle="tab" href="#service"
             role="tab"
             aria-controls="service" aria-selected="false"><i class=" px-2 fas fa-tools"></i></a>
        </li>
        <li class="nav-item col">
          <a class="btn btn-outline-secondary border-left-0 w-100" id="contact-tab" data-toggle="tab" href="#chart"
             role="tab"
             aria-controls="chart" aria-selected="false" style=" border-radius: 0px 5px 5px 0px !important;"><i
              class=" px-2 fas fa-chart-pie"></i></a>
        </li>
      </ul>
      <div class="tab-content" id="myTabContent">
        <div class="tab-pane fade show active" id="fuel" role="tabpanel" aria-labelledby="fuel-tab">
          <div style="overflow-y:scroll; height:80vh;">
            {% for detail in car %}

            <form method="post" action="{% url 'cars:add_fuel_fill' detail.pk  %}" id="add_fuel_fill">{% csrf_token %}
              <table class="table table-bordered bg-light table-sm table-striped mb-0" id="filling_table">
                <thead class="bg-secondary text-center text-light">
                <tr>
                  <th scope="col" class="d-none d-md-table-cell">Lp.</th>
                  <th scope="col">Data</th>
                  <th scope="col">Litry</th>
                  <th scope="col">KM</th>
                  <th scope="col">Cena / L</th>
                  <th scope="col">Stan Licznika</th>
                  <th scope="col">L / 100km</th>
                </tr>
                </thead>
                <tbody>
                <tr class="" style="position:relative">
                  <td class=" m-0 p-0 d-none d-md-block"></td>
                  <td class=" m-0 p-0" style="max-width:112px;">{{car_fill_form.date}}</td>
                  <td class=" m-0 p-0">{{car_fill_form.liters}}</td>
                  <td class=" m-0 p-0">{{car_fill_form.kilometers}}</td>
                  <td class=" m-0 p-0">{{car_fill_form.fuel_price}}</td>
                  <td class=" m-0 p-0">{{car_fill_form.mileage}}</td>
                  <td class=" m-0 p-0">
                    <button id="save_filling_btn" class="btn border fas fa-save" type="submit"></button>
                  </td>
                  <td id="save_overlay" class="alert alert-info text-center rounded shadow "
                      style="position: absolute; left:20%; width:60%; display:none;">...Zapisywanie...
                  </td>
                </tr>
                {% for filling in car_fuel_fill_list %}
                <tr id="filling_row_{{filling.pk}}">
                  <th class="d-none d-md-block">{{forloop.counter}}</th>
                  <td>{{filling.date|date:"d M Y" }}</td>
                  <td>{{filling.liters}}</td>
                  <td>{{filling.kilometers}}</td>
                  <td>{{filling.fuel_price}}</td>
                  <td>{{filling.mileage}}</td>
                  <td class="d-flex justify-content-between align-items-center">
                    <span>{{ filling.liters|average_fuel_cons:filling.kilometers }}</span>
                    <a onclick="return confirm('Usunąć tankowanie?')" id="filling_{{filling.pk}}"
                       class="filling_ far fa-trash-alt text-dark" href="#filling_{{filling.pk}}"></a>
                  </td>
                </tr>
                {% endfor %}
                </tbody>
              </table>
            </form>
            {% endfor %}
            <div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog"
                 aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered" role="document">
                <form class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLongTitle">Modal title</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                  <div class="modal-body">
                    ...
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Zapisz</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
        <div class="tab-pane fade p-2" id="service" role="tabpanel" aria-labelledby="service-tab">
          <table class="d-none d-lg-table table table-bordered bg-light table-sm table-striped mb-0">
            <thead class="bg-secondary text-center text-light">
              <tr>
                <td>Lp.</td>
                <td>Data</td>
                <td>Przebieg [km]</td>
                <td>Części/Usługi - cena [PLN]</td>
                <td>Robocizna [PLN]</td>
                <td>Koszt całkowity [PLN]</td>
                <td>Faktury</td>
              </tr>
            </thead>
            <tbody>
            {% for service, lists in service_dictionary.items %}
            <tr class="text-center">
              <td class="align-middle">{{forloop.counter}}</td>
              <td class="align-middle">{{service.date}}</td>
              <td class="align-middle">{{service.mileage}}</td>
              <td class="">
                <table class="w-100 table table-light mb-0">
                  {% for part in lists.0 %}
                  <tr>
                    <td class="d-flex justify-content-between">
                       <span>{{part}}</span><span>{{part.price}}</span>
                    </td>
                  </tr>
                  {% endfor %}
                </table>
              </td>
              <td class="align-middle">{{service.labour}}</td>
              <td class="align-middle">{{ service.labour|add:lists.2 }}</td>
              <td class="text-left align-middle">
                {% for invoice in lists.1 %}
                 <a href="{{invoice.file}}" class="text-secondary fas fa-file-invoice-dollar">
                   <small>{{invoice}}</small>
                 </a><br>
                {% endfor %}
              </td>
            </tr>

            {% endfor %}
            </tbody>
          </table>
          <div class="row d-lg-none">
            {% for service, lists in service_dictionary.items %}
            <div class="col-12 mb-1" >
              <div class="card border-dark mb-3" style="height:100%;">
                <div class="card-header bg-transparent border-dark d-flex justify-content-between">
                  <i>{{forloop.counter}}. {{service.date}}</i> <i>{{service.mileage}} KM</i>
                </div>
                <div class="card-body text-secondary row  no-gutters p-1">
                  <div class="col-7 pr-1 border-right">
                    <p class="text-center m-0 small">Części/Usługi</p>
                    <table class="table-bordered w-100">
                      <tbody>
                      {% for part in lists.0 %}
                      <tr>
                        <td>{{part}}</td>
                        <td class="text-right">{{part.price}}</td>
                      </tr>
                      {% endfor %}
                      <tr>
                        <td>Robocizna</td>
                        <td class="text-right">{{service.labour}}</td>
                      </tr>
                      </tbody>
                    </table>
                  </div>
                  <div class="col-5  pl-1">
                    <p class="text-center m-0 small">Faktury/Paragony</p>
                    <table class="table-bordered">
                      {% for invoice in lists.1 %}
                      <a href="{{invoice.file}}" class="text-secondary fas fa-file-invoice-dollar">
                        <small>{{invoice}}</small></a>
                      {% endfor %}
                    </table>
                  </div>
                </div>
                <div class="card-footer bg-transparent border-dark">KOSZT CAŁKOWITY: {{ service.labour|add:lists.2 }} PLN</div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
        <div class="tab-pane fade" id="chart" role="tabpanel" aria-labelledby="chart-tab">
          <canvas class="bg-light rounded p-1" id="myChart"></canvas>
          <script>
          var ctx = document.getElementById('myChart').getContext('2d');
          var chart_data_json = JSON.parse('{{chart_dates|escapejs }}');
          var dates_array = []
          var consumption_array = []
          var average_array = []
          var liters_array = []
          var kilometers_array = []
          var bars_color_array = []
          chart_data_json.forEach(getDatesArray);
          chart_data_json.forEach(average);

          for (var i=0; i<average_array.length; i++){
            if(average_array[i]> consumption_array[i]){
              bars_color_array.push('rgba(50,102,71,1)')
            }else{
              bars_color_array.push('rgba(255,193,7,1)')
            }
          }

          var mixedChart = new Chart(ctx, {
            type: 'bar',
            data: {
              datasets: [{
                label: 'L/100KM',
                data: consumption_array,
                backgroundColor: bars_color_array
              }, {
                label: 'Średnie: '+ average_array[0] ,
                data: average_array,
                borderColor: 'rgba(61,205,88,1)',
                // Changes this dataset to become a line
                type: 'line',
                fill: false,
                pointRadius: 0
              }],
              labels: dates_array
            },
          options: {

            scales: {
              yAxes: [{
                  ticks: {
                      beginAtZero: false,
                      suggestedMin: 5,
                      suggestedMax: 10
                  }
              }]
            }
        }
        });

          function getDatesArray(item, index){
          dates_array.push(item['fields']['date']);
          var l = item['fields']['liters'];
          var km = item['fields']['kilometers'];
          consumption_array.push((l/km*100).toFixed(2));
          liters_array.push(l);
          kilometers_array.push(km)
          }
          var liters_total = liters_array.reduce((a, b) => a + b, 0)
          var kilometers_total = kilometers_array.reduce((a, b) => a + b, 0)
          function average(){
            average_array.push((((liters_array.reduce((a, b) => a + b, 0))/(kilometers_array.reduce((a, b) => a + b, 0)))*100).toFixed(2))
          }



          </script>
        </div>
      </div>
    </div>
    <div class="col-12 col-xl-3">
      <nav class="navbar navbar-expand-xl navbar-light bg-light">
        <button class="navbar-toggler btn-block shadow" type="button" data-toggle="collapse" data-target="#car_details"
                aria-controls="car_details" aria-expanded="false" aria-label="Toggle navigation">
          <span>dane techniczne</span><span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="car_details">
          <div class="card w-100 ">
            {% for detail in car %}
            {% if detail.image %}
            <img class="card-img-top" style="width:100%;" src="{{detail.image.url}}" alt="{{detail}}">
            {% else %}
            <img class="card-img-top mx-auto" style="width:100%;" src="{% static 'todo/img/car-solid.svg'%}"
                 alt="{{detail}}">
            {% endif %}
            <div class="card-body">
              <h5 class="card-title mb-0">{{detail.name}}</h5>
            </div>
            <ul class="list-group list-group-flush">
              <li class="list-group-item d-flex justify-content-between align-items-center py-md-1 bg-light">
            <span>
              <span class="text-dark">Marka:</span>
            </span>
                <span>
              <h6 class="mb-0"><span class="badge badge-dark badge-pill">{{detail.make}}</span></h6>
            </span>
              </li>
              <li class="list-group-item d-flex justify-content-between align-items-center py-md-1 bg-light">
            <span>
              <span class="text-dark">Model:</span>
            </span>
                <span>
              <h6 class="mb-0"><span class="badge badge-dark badge-pill">{{detail.model}}</span></h6>
            </span>
              </li>
              <li class="list-group-item d-flex justify-content-between align-items-center py-md-1 bg-light">
            <span>
              <span class="text-dark">Rok produkcji:</span>
            </span>
                <span>
              <h6 class="mb-0"><span class="badge badge-dark badge-pill">{{detail.year}}</span></h6>
            </span>
              </li>
              <li class="list-group-item d-flex justify-content-between align-items-center py-md-1 bg-light">
            <span>
              <span class="text-dark">Silnik:</span>
            </span>
                <span>
              <h6 class="mb-0"><span class="badge badge-dark badge-pill">{{detail.engine}}</span></h6>
            </span>
              </li>
              <li class="list-group-item d-flex justify-content-between align-items-center py-md-1 bg-light">
            <span>
              <span class="text-dark">Moc:</span>
            </span>
                <span>
              <h6 class="mb-0"><span class="badge badge-dark badge-pill">{{detail.power}} KM</span></h6>
            </span>
              </li>
              <li class="list-group-item d-flex justify-content-between align-items-center py-md-1 bg-light">
            <span>
              <span class="text-dark">Przebieg w dn zakupu:</span>
            </span>
                <span>
              <h6 class="mb-0"><span class="badge badge-dark badge-pill">{{detail.mileage}} KM</span></h6>
            </span>
              </li>
              <li class="list-group-item d-flex justify-content-between align-items-center py-md-1 bg-light">
            <span>
              <span class="text-dark">Ostatni serwis/usterka:</span>
            </span>
                <span>
              <h6 class="mb-0"><span class="badge badge-dark badge-pill">todo KM</span></h6>
            </span>
              </li>
              <li class="list-group-item d-flex justify-content-between align-items-center py-md-1 bg-light">
            <span>
              <span class="text-dark">Średnie zużycie paliwa:</span>
            </span>
                <span>
              <h6 class="mb-0"><span class="badge badge-dark badge-pill">todo L /1 00KM</span></h6>
            </span>
              </li>
              <li class="list-group-item d-flex justify-content-between align-items-center py-md-1 bg-light">
                <a class="btn btn-secondary btn-block btn-sm" href="{% url 'cars:car_edit' detail.pk %}">EDYCJA</a>
              </li>
            </ul>

          </div>
        </div>
      </nav>
    </div>
  </div>
</div>
<script type="text/javascript">
  $('body').on('submit','#add_fuel_fill',function(e){
    e.preventDefault();
    console.log('ajax'+ {{detail.pk}});
    $.ajax({
      type:'POST',
      url:'/cars/carDetails/{{detail.pk}}/add_fuel_fill',
      data:{
        date:$('#id_date').val(),
        liters:$('#id_liters').val(),
        kilometers:$('#id_kilometers').val(),
        fuel_price:$('#id_fuel_price').val(),
        mileage:$('#id_mileage').val(),
        csrfmiddlewaretoken:$('input[name=csrfmiddlewaretoken]').val(),
      },
      success: function(json){

        $('#id_liters').val('');
        $('#id_kilometers').val('');
        fuel_price:$('#id_fuel_price').val('');
        mileage:$('#id_mileage').val('');
        $('#save_overlay').fadeIn();
        setTimeout (function() {
        $('#save_overlay').fadeOut();
        $('#filling_table').load(document.URL + ' #filling_table');
        console.log('time');
      }, 1000);
      }
    });
  });


</script>
{% endfor %}
<script type="text/javascript">
  $('body').on('click','.filling_',function(e){
    e.preventDefault();
    console.log(e.target.id);
    var id = e.target.id
    var num_id = id.split('_')[1]
    $.ajax({
      type:'GET',
      url:'/cars/carDetails/'+ parseInt(num_id) + '/delete_fuel_fill',
      data:{

      },
      success: function(json){
        setTimeout (function() {
        $('#filling_table').load(document.URL + ' #filling_table');
      }, 200);
      }
    });
  });


</script>
{% endblock %}
